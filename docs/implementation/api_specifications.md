# AIコウチョウ - API仕様書

## 1. Vertex AI連携仕様

### 1-1. テキスト変換API

#### リクエスト

```json
{
  "text": "入力テキスト",
  "style": "principal",
  "tone": "formal",
  "max_length": 1000
}
```

#### レスポンス

```json
{
  "transformed_text": "変換後テキスト",
  "status": "success",
  "processing_time": "2.5"
}
```

### 1-2. プロンプト設定

- システムプロンプト：校長先生らしい話し方への変換指示
- 文体調整：丁寧語、敬語の適切な使用
- 文末表現：訓示的、教育的な表現の付与
- 禁止ワード：不適切な表現のフィルタリング
- 文脈保持：一貫性のある話の展開
- 教育的要素：学びや成長に関する表現の追加
- 季節感：時期に応じた表現の使用

### 1-3. エラーパターン

- INVALID_INPUT: 入力テキストが制限に違反
- TRANSFORMATION_FAILED: 変換処理の失敗
- TIMEOUT: 処理時間超過
- RATE_LIMIT_EXCEEDED: API利用制限超過

## 2. Cloud TTS連携仕様

### 2-1. 音声合成API

#### リクエスト

```json
{
  "text": "変換後テキスト",
  "voice": {
    "language_code": "ja-JP",
    "name": "ja-JP-Neural2-C",
    "speaking_rate": 0.9,
    "pitch": -2.0
  },
  "audio_config": {
    "audio_encoding": "MP3",
    "speaking_rate": 0.9,
    "pitch": -2.0,
    "volume_gain_db": 0.0
  }
}
```

#### レスポンス

```json
{
  "audio_content": "base64エンコードされた音声データ",
  "status": "success",
  "duration": "30.5"
}
```

### 2-2. 音声パラメータ

- 声質：年配男性向けパラメータ
- 話速：0.9（標準よりやや遅め）
- ピッチ：-2.0（低め）
- 抑揚：自然な抑揚の維持
- 間の取り方：文節間に適切な間を挿入
- 感情表現：文脈に応じた抑揚の変化
- SSML制御：強調やポーズの細かい調整

### 2-3. エラーパターン

- INVALID_SSML: SSML構文エラー
- SYNTHESIS_FAILED: 音声合成失敗
- AUDIO_LENGTH_EXCEEDED: 音声長制限超過
- QUOTA_EXCEEDED: 利用量制限超過

## 3. D-ID連携仕様

### 3-1. アバター生成API

#### リクエスト

```json
{
  "source_url": "アバター画像URL",
  "audio": {
    "audio_url": "音声ファイルURL"
  },
  "config": {
    "stitch": true,
    "result_format": "mp4",
    "fluent": true,
    "pad_audio": "0.5"
  }
}
```

#### レスポンス

```json
{
  "id": "生成タスクID",
  "status": "created",
  "result_url": "生成された動画URL",
  "created_at": "2024-01-01T00:00:00Z"
}
```

### 3-2. アバター設定

- 表情：自然な表情変化
- 口の動き：音声に同期
- 視線：適度な動き
- 姿勢：威厳のある直立姿勢
- ジェスチャー：教育者らしい手の動き
- 表情バリエーション：
  - 通常：穏やかな表情
  - 強調時：やや眉を上げる
  - 締めくくり：微笑み
- 背景設定：学校の校長室を想起させる環境

### 3-3. エラーパターン

- INVALID_SOURCE: アバター画像不正
- AUDIO_PROCESSING_FAILED: 音声処理失敗
- GENERATION_FAILED: 動画生成失敗
- WEBHOOK_FAILED: コールバック失敗

## 4. エラーハンドリング定義

### 4-1. 共通エラーコード

| コード | 説明 | 対応 |
|--------|------|------|
| 400 | 不正なリクエスト | パラメータの検証 |
| 401 | 認証エラー | 認証情報の更新 |
| 403 | 権限エラー | 利用制限の確認 |
| 429 | レート制限 | リトライ制御 |
| 500 | サーバーエラー | システム管理者に通知 |
| 503 | サービス利用不可 | 一時的な待機 |

### 4-2. リトライ制御

- 初回リトライ：30秒後
- 最大リトライ回数：3回
- バックオフ係数：2倍
- タイムアウト：120秒

### 4-3. エラーログ

#### ログフォーマット

```json
{
  "timestamp": "2024-01-01T00:00:00Z",
  "error_code": "ERROR_CODE",
  "service": "SERVICE_NAME",
  "message": "エラーメッセージ",
  "request_id": "リクエストID",
  "user_id": "ユーザーID",
  "stack_trace": "スタックトレース"
}
```

### 4-4. エラー通知

- 重大度レベル
  - INFO: 軽微な問題
  - WARN: 注意が必要
  - ERROR: 対応必要
  - FATAL: 緊急対応必要

- 通知チャネル
  - Slack: 即時通知
  - Email: 定期レポート
  - 管理画面: リアルタイム監視

### 4-5. 障害復旧手順

1. エラー検知
2. 影響範囲の特定
3. 一時的な回避策の実施
4. ユーザーへの通知
5. 根本原因の分析
6. 恒久的な対策の実施
7. 再発防止策の検討

### 4-6. パフォーマンスモニタリング

- 監視項目
  - API応答時間
  - エラー発生率
  - リソース使用率
  - 同時リクエスト数

- アラート閾値
  - 応答時間: 3秒以上
  - エラー率: 5%以上
  - CPU使用率: 80%以上
  - メモリ使用率: 85%以上

### 4-7. デバッグ情報

- デバッグモード時の追加情報
  - 詳細なスタックトレース
  - メモリ使用状況
  - API呼び出しの依存関係
  - キャッシュヒット率

### 4-8. セキュリティ対策

- 認証・認可
  - APIキーの定期的なローテーション
  - アクセストークンの有効期限設定
  - IPアドレス制限

- データ保護
  - 通信の暗号化（TLS 1.3）
  - 個人情報の匿名化
  - ログの暗号化

### 4-9. キャッシュ戦略

- キャッシュ対象
  - 頻繁に使用される変換結果
  - アバターテンプレート
  - 音声パターン

- キャッシュ設定
  - TTL: 24時間
  - 最大サイズ: 1GB
  - 更新戦略: LRU
