# AIコウチョ - アーキテクチャ検討ドキュメント

以下では、「AIコウチョ」サービスの全体的なアーキテクチャについて検討します。  
ユーザーがテキストを入力してから、校長先生風のスピーチ動画を得るまでのデータフロー・コンポーネントを整理します。

## 1. 全体構成図

```mermaid
flowchart LR
  subgraph FrontEnd
    UI[ウェブ/モバイルUI] --> APICall[API呼び出し]
  end

  subgraph Backend
    APICall --> CF1[Cloud Function/Serverless Endpoint] --> VAI[Vertex AI (PaLM2)]
    CF1 --> TTS[Cloud TTS]
    TTS --> GCSUpload[音声ファイルをCloud Storageへ保存]
    GCSUpload --> AvGen[外部アバター生成サービスAPI呼び出し]
    AvGen --> GCSVideo[完成動画をCloud Storageへ保存]
  end

  GCSVideo --> CF2[ステータス更新 or 動画URL返却]
  CF2 --> UI[動画プレビュー表示]
```

上記の通り、フロントエンド・バックエンド・外部サービスを連携させる形を想定します。

## 2. 各コンポーネントの役割

### 2-1. フロントエンド (UI)

- ユーザー入力フォーム
  - ユーザーが自由にテキストを入力するフォームを提供
  - 入力サポート機能UI
    - キーワード入力フィールド
    - テーマ選択ドロップダウン
    - AI生成案の表示・選択領域
- 動画生成リクエスト
  - 入力フォームの内容をバックエンドへ送信し、生成完了時にプレビューリンクやダウンロードボタンを表示
- 進捗表示
  - 動画生成にやや時間がかかる場合、ローディング表示またはステータス更新を行う

### 2-2. バックエンド (API / Cloud Functions)

- 入力サポート (Vertex AI)
  - キーワードやテーマに基づく文章展開
  - 複数の展開案生成
  - 文章の編集・調整支援
- テキスト変換 (Vertex AI)
  - 段階的な変換プロセス
    1. コンテンツ拡充フェーズ
       - 入力内容の本質的なメッセージを抽出
       - 教育的な要素や人生の教訓を追加
    2. 文体変換フェーズ
       - 校長先生らしい言い回しや表現への変換
       - 格調高い言葉遣いの追加
    3. 構造最適化フェーズ
       - スピーチとしての構成を整理
       - 起承転結の調整
  - ガードレール設定やポリシー (不適切表現除外) を適用
- 音声合成 (Cloud TTS)
  - 変換後のスピーチをTTSで音声ファイル(mp3等)に変換。
  - イントネーションやスピーチ長の調整。
- Cloud Storage へのアップロード
  - 生成された音声ファイルを一時保管。
  - 後続のアバター生成サービスがアクセスできるようにするか、必要に応じてダウンロードURLを発行する。
- アバター生成サービス連携
  - 外部アバター生成 (Synthesia, D-ID, HeyGenなど) に音声を渡し、口パク動画を生成。
  - 動画生成完了後、返却された動画ファイルを再度 Cloud Storage に保存。
- ステータス管理 / レスポンス
  - 動画生成の進捗や完了時のURLをフロントエンドに返す。

### 2-3. 外部アバター生成サービス

- アバター動画生成
  - 渡された音声ファイルとスクリプト情報（口パク、字幕など）を元に動的な動画を作成。
  - AIキャラクターの見た目や背景設定をAPIパラメータで指定可能。
- 動画ファイル返却
  - 完成した動画をバックエンド (もしくはCloud Storage) に送信。
  - 生成に時間がかかる場合は非同期コールバック等を使用する場合も。

## 3. データフロー詳細

### 3-1. ユーザー入力

- フロントエンドからユーザーの入力テキストを Cloud Function (CF1) に送信。

### 3-2. 校長先生口調への変換

1. 入力サポートフェーズ

   - ユーザーのキーワードやテーマを元に、AIが文章の素案を生成
   - 複数の展開案からユーザーが選択または編集

2. コンテンツ拡充フェーズ

   - 入力例：「今日はお腹がすいたから昼寝したい」
   - 変換1：「体調管理と休息の大切さについて考えさせられる出来事がありました」
   - メッセージの本質を抽出し、教育的な文脈を追加

3. 文体変換フェーズ

   - 変換2：「生徒諸君、心身の健康管理という観点から、大切なお話をさせていただきたいと思います」
   - 校長先生らしい言い回しや表現を適用

4. 構造最適化フェーズ
   - 最終形：「生徒諸君、本日は心身の健康管理について、皆さんと共に考えてみたいと思います。
     日々の生活の中で、疲労を感じることは自然なことです。
     しかし、その疲れをどのように克服するか、それこそが皆さんの成長の機会となるのです。
     適切な休息を取り、明日への活力を蓄えることも、立派な自己管理の一つだと考えています。」
   - スピーチとしての構成を整理し、メッセージ性を強化

### 3-3. 音声合成

- リライト結果を Cloud TTS に渡し、音声ファイルを生成。
- ファイルを Cloud Storage (GCS) に保存し、ファイルパス or ダウンロードURLを取得。

### 3-4. アバター生成

- CF1 が外部アバター生成サービス (AvGen) に音声ファイルのURLを渡す。
- アバター動画が完成すると、サービス側から動画ファイル (mp4等) が返される。
- CF1 は受け取った動画を GCS に保存。

### 3-5. レスポンス返却

- 動画保存完了後、CF1 は 動画URL をフロントエンドに返す。
- フロントエンドはプレビューまたはダウンロードリンクを表示。

## 4. 技術選択・構成のポイント

### 4-1. Vertex AI (PaLM 2)

- 入力サポート機能
  - キーワード展開プロンプト
  - テーマ別テンプレート
  - 文章編集支援プロンプト
- 校長先生変換機能
  - 3段階変換プロンプト設計
    - コンテンツ拡充プロンプト
    - 文体変換プロンプト
    - 構造最適化プロンプト
  - 不適切ワードフィルタや調整を行い、安全性を確保

### 4-2. Cloud TTS

- 校長先生風の声質 (落ち着いた男性 / 女性) を選べるようにする。
- SSML (Speech Synthesis Markup Language) により、ポーズ・抑揚を制御。

### 4-3. Cloud Storage

- 音声ファイル、動画ファイルを一時保管。
- 生成後、GCS URL または署名付きURLを発行してクライアントに提供。

### 4-4. 外部アバター生成API

- 口パクのリップシンクや背景変更など、細かいオプションを提供しているサービスを選択。
- 利用料金・生成速度・クオリティに応じて最適なサービスを比較検討。

## 5. スケーラビリティ / パフォーマンス

### 5-1. Serverless構成

- Cloud Functions や Cloud Run を使用することで、アクセス集中時にオートスケーリングが期待できる。

### 5-2. バックグラウンド処理

- アバター動画の生成には数十秒〜数分かかる場合があるため、非同期ジョブ管理を検討。
- Pub/Sub + Cloud Functions でワークキューを実装し、生成完了時に通知する方式もあり。

### 5-3. キャッシュ / CDN

- 生成後の動画は変更がないため、GCS 上でキャッシュ設定をし、CDN 経由で高速配信を行うことも可。

## 6. セキュリティ・運用考慮

### 6-1. 認証・認可

- 特定ユーザーのみが動画生成できる仕組み (Firebase Auth 等) を導入するか検討。

### 6-2. 費用管理

- APIコールが多いほどコスト増大の恐れ。無料枠や使用上限を設定し、モニタリングダッシュボードを活用。

### 6-3. コンテンツモデレーション

- 差別的・公序良俗に反する入力を校長先生口調に変換するリスクあり。
- ユーザー入力段階でバリデーションやNGワードチェックを行うか、もしくはAIモデルのセーフティ設定を厳格化。

## 7. まとめ

- フロントエンド: シンプルなUIでユーザーが入力 → 動画生成リクエスト。
- バックエンド: Vertex AI + Cloud TTS を中心に、ユーザー入力を"校長先生スピーチ"化 → アバター生成。
- アバター生成サービス: 外部連携による口パク動画の自動作成。
- Cloud Storage: 音声・動画を保存し、必要に応じてURLを発行。

本アーキテクチャにより、ユーザーのちょっとしたアイデアや冗談を、あっという間に校長先生スピーチ動画へと変換できる仕組みが実現できます。スケール面・コスト面・セキュリティ面を考慮しつつ、順次拡張していくことで、より多くの人が楽しめるサービスとなるでしょう。
